<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ–π –∫–∞–Ω–∞–ª - Yos1k Paint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9); filter: blur(10px); }
            to { opacity: 1; transform: scale(1); filter: blur(0); }
        }

        @keyframes starsMove {
            from { background-position: 0 0, 40px 60px, 130px 270px; }
            to { background-position: 1000px 1000px, 1040px 1060px, 1130px 1270px; }
        }

        @keyframes pulseBorder {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        @keyframes nebulaFloat {
            0% { transform: translate(0, 0) scale(1); opacity: 0.3; }
            50% { transform: translate(2%, 2%) scale(1.1); opacity: 0.5; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
        }

        @keyframes textGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            background-color: #020617;
            touch-action: none;
            font-family: ui-sans-serif, system-ui, sans-serif;
            margin: 0;
            overflow: hidden;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0));
            background-size: 200px 200px;
            animation: starsMove 60s linear infinite;
        }

        .nebula {
            position: fixed;
            inset: -10%;
            background: radial-gradient(circle at 30% 40%, rgba(124, 58, 237, 0.1), transparent 40%),
                        radial-gradient(circle at 70% 60%, rgba(219, 39, 119, 0.1), transparent 40%);
            z-index: -1;
            filter: blur(80px);
            animation: nebulaFloat 20s ease-in-out infinite;
        }

        .canvas-container {
            position: relative;
            background-color: #ffffff;
            background-image: 
                repeating-linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0), 
                repeating-linear-gradient(45deg, #f0f0f0 25%, #ffffff 25%, #ffffff 75%, #f0f0f0 75%, #f0f0f0);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            border: 4px solid rgba(255, 255, 255, 0.1);
        }

        canvas {
            cursor: crosshair;
            display: block;
            image-rendering: auto;
        }

        #selectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 5;
        }

        #welcomeScreen {
            z-index: 100;
            background: linear-gradient(180deg, #dc2626 0%, #facc15 100%);
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .welcome-card {
            animation: zoomIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .tool-btn {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            color: #94a3b8;
        }
        
        .tool-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #ef4444 0%, #facc15 100%);
            color: white;
            animation: pulseBorder 2s infinite;
        }

        .gradient-text {
            background: linear-gradient(to right, #ef4444, #facc15, #ef4444);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: textGradient 3s linear infinite;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(32px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-hidden { display: none !important; }

        .objects-library {
            position: absolute;
            left: 24px;
            top: 100px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 12px;
            z-index: 20;
            width: 140px;
        }

        .object-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .object-item {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .object-item.selected {
            border-color: #facc15;
            background: rgba(250, 204, 21, 0.1);
        }
    </style>
</head>
<body class="flex flex-col h-screen w-screen overflow-hidden">

    <div class="nebula"></div>

    <!-- –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø -->
    <div id="welcomeScreen">
        <div class="welcome-card p-12 rounded-[3rem] text-center max-w-lg mx-4 border border-white/10 bg-black/40 backdrop-blur-3xl shadow-2xl">
             <h1 class="text-7xl font-black mb-12 gradient-text">Yos1k paint</h1>

             <button id="quickEnterBtn" class="w-full bg-gradient-to-r from-red-600 to-yellow-500 hover:from-red-500 hover:to-yellow-400 text-white text-xl font-black py-6 rounded-2xl transition-all active:scale-95 uppercase tracking-widest shadow-lg">
                –û—Ç–∫—Ä—ã—Ç—å —Ö–æ–ª—Å—Ç
             </button>

             <a href="https://www.youtube.com/@Yos1kGD" target="_blank" class="block mt-8 text-white/60 hover:text-white transition-colors text-sm font-medium flex items-center justify-center gap-2">
                 <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                 –ú–æ–π YouTube –∫–∞–Ω–∞–ª
             </a>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="mainApp" class="flex flex-col h-full w-full app-hidden">
        <div class="glass-panel px-6 py-3 flex items-center justify-between z-10 flex-wrap gap-4 shadow-xl">
            <div class="flex items-center gap-4">
                <input type="color" id="colorPicker" value="#ef4444" class="w-10 h-10 cursor-pointer rounded-xl border-0 bg-transparent transition-transform hover:scale-110">
                
                <div class="flex flex-col w-24">
                    <input type="range" id="brushSize" min="1" max="150" value="20" class="h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-red-500">
                    <span id="brushSizeDisplay" class="text-[10px] font-bold text-slate-400 uppercase mt-2 text-center">–†–∞–∑–º–µ—Ä: 20px</span>
                </div>

                <div class="flex bg-white/5 p-1 rounded-2xl gap-1 border border-white/10">
                    <button id="undoBtn" class="tool-btn" title="–û—Ç–º–µ–Ω–∏—Ç—å" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                    </button>
                    <button id="redoBtn" class="tool-btn" title="–í–µ—Ä–Ω—É—Ç—å" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/></svg>
                    </button>
                </div>

                <div class="flex bg-white/5 p-1 rounded-2xl gap-1 border border-white/10">
                    <button id="brushBtn" class="tool-btn active" title="–ö–∏—Å—Ç—å"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg></button>
                    <button id="textBtn" class="tool-btn" title="–¢–µ–∫—Å—Ç"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg></button>
                    <button id="eraserBtn" class="tool-btn" title="–õ–∞—Å—Ç–∏–∫"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/></svg></button>
                    <button id="bucketBtn" class="tool-btn" title="–ó–∞–ª–∏–≤–∫–∞"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m19 11-8-8-8.6 8.6a2 2 0 0 0 0 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11Z"/><path d="M2 13h15"/></svg></button>
                    <button id="scissorsBtn" class="tool-btn" title="–í—ã—Ä–µ–∑–∞—Ç—å –∏ –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 3h7v7H3z"/><path d="M14 3h7v7h-7z"/><path d="M14 14h7v7h-7z"/><path d="M3 14h7v7H3z"/><path d="m8 8 8 8"/></svg></button>
                </div>

                <div id="textInputWrapper" class="hidden">
                    <input type="text" id="brushTextInput" value="Yos1k" class="w-24 bg-white/5 border border-white/10 text-white rounded px-2 text-xs h-10">
                </div>

                <div class="flex items-center gap-3 bg-white/5 p-2 rounded-2xl border border-white/10">
                    <label class="cursor-pointer bg-white/10 hover:bg-white/20 p-2 rounded-lg" title="–ú—É–∑—ã–∫–∞">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                        <input type="file" id="musicUpload" accept="audio/*" class="hidden">
                    </label>
                    <button id="musicToggle" class="text-white"><svg id="playIcon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
                    <input type="range" id="musicVolume" min="0" max="1" step="0.01" value="0.5" class="h-1 w-16 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-yellow-500">
                </div>
            </div>

            <div class="flex gap-3">
                <button id="clearBtn" class="bg-slate-800 hover:bg-red-600 text-slate-400 px-4 py-2 rounded-xl text-[10px] font-black transition-all border border-slate-700 uppercase">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button id="saveBtn" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-xl text-[10px] font-black transition-all border border-white/10 uppercase">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div class="objects-library">
            <div class="flex items-center justify-between mb-2">
                <span class="text-[10px] text-white/30 uppercase font-bold tracking-wider">–û–±—ä–µ–∫—Ç—ã</span>
                <label class="cursor-pointer bg-white/10 hover:bg-white/20 px-2 py-1 rounded-md text-[10px] text-white font-bold transition-colors">
                    +
                    <input type="file" id="objectUpload" accept="image/*" class="hidden">
                </label>
            </div>
            
            <div id="objectsContainer" class="object-grid">
                <div class="object-item" data-type="emoji" data-value="üî•"><span class="text-xl">üî•</span></div>
                <div class="object-item" data-type="emoji" data-value="‚≠ê"><span class="text-xl">‚≠ê</span></div>
                <div class="object-item" data-type="emoji" data-value="üíÄ"><span class="text-xl">üíÄ</span></div>
                <div class="object-item" data-type="emoji" data-value="üëë"><span class="text-xl">üëë</span></div>
                <div class="object-item" data-type="emoji" data-value="üëæ"><span class="text-xl">üëæ</span></div>
                <div class="object-item" data-type="emoji" data-value="‚ù§Ô∏è"><span class="text-xl">‚ù§Ô∏è</span></div>
            </div>
        </div>

        <div id="canvasWrapper" class="relative flex-grow flex items-center justify-center p-6">
            <div class="canvas-container">
                <canvas id="paintCanvas"></canvas>
                <canvas id="selectionCanvas"></canvas>
            </div>
        </div>
    </div>

    <audio id="audioElement" loop crossorigin="anonymous"></audio>

    <script>
        const elements = {
            welcome: document.getElementById('welcomeScreen'),
            enterBtn: document.getElementById('quickEnterBtn'),
            main: document.getElementById('mainApp'),
            canvas: document.getElementById('paintCanvas'),
            selectionCanvas: document.getElementById('selectionCanvas'),
            wrapper: document.getElementById('canvasWrapper'),
            color: document.getElementById('colorPicker'),
            size: document.getElementById('brushSize'),
            sizeDisplay: document.getElementById('brushSizeDisplay'),
            textInputWrap: document.getElementById('textInputWrapper'),
            textInput: document.getElementById('brushTextInput'),
            clear: document.getElementById('clearBtn'),
            save: document.getElementById('saveBtn'),
            undo: document.getElementById('undoBtn'),
            redo: document.getElementById('redoBtn'),
            audio: document.getElementById('audioElement'),
            musicUpload: document.getElementById('musicUpload'),
            musicToggle: document.getElementById('musicToggle'),
            musicVol: document.getElementById('musicVolume'),
            playIcon: document.getElementById('playIcon'),
            objectUpload: document.getElementById('objectUpload'),
            objectsContainer: document.getElementById('objectsContainer'),
            scissorsBtn: document.getElementById('scissorsBtn')
        };

        const ctx = elements.canvas.getContext('2d', { willReadFrequently: true });
        const sCtx = elements.selectionCanvas.getContext('2d');
        
        let isDrawing = false;
        let currentTool = 'brush';
        let selectedObject = null;
        let history = [];
        let historyIdx = -1;
        const maxHistory = 30;

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        let selectionRect = null;
        let movingImageData = null;
        let isMoving = false;
        let dragOffset = { x: 0, y: 0 };

        // –í—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        elements.enterBtn.onclick = () => {
            elements.welcome.style.opacity = '0';
            setTimeout(() => {
                elements.welcome.classList.add('app-hidden');
                elements.main.classList.remove('app-hidden');
                initCanvas();
            }, 500);
        };

        function initCanvas() {
            const w = Math.min(elements.wrapper.clientWidth - 48, 1400);
            const h = Math.min(elements.wrapper.clientHeight - 48, 900);
            
            elements.canvas.width = w;
            elements.canvas.height = h;
            elements.selectionCanvas.width = w;
            elements.selectionCanvas.height = h;

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            const saved = localStorage.getItem('yos1k_paint_local');
            if (saved) {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                    saveToHistory();
                };
                img.src = saved;
            } else {
                saveToHistory();
            }
        }

        // --- –õ–û–ì–ò–ö–ê –†–ò–°–û–í–ê–ù–ò–Ø ---

        function saveToHistory() {
            const data = elements.canvas.toDataURL();
            if (historyIdx < history.length - 1) {
                history = history.slice(0, historyIdx + 1);
            }
            history.push(data);
            if (history.length > maxHistory) history.shift();
            else historyIdx++;
            updateHistoryButtons();
            localStorage.setItem('yos1k_paint_local', data);
        }

        function undo() {
            if (historyIdx > 0) {
                historyIdx--;
                loadHistoryState();
            }
        }

        function redo() {
            if (historyIdx < history.length - 1) {
                historyIdx++;
                loadHistoryState();
            }
        }

        function loadHistoryState() {
            const img = new Image();
            img.onload = () => {
                ctx.globalCompositeOperation = 'source-over';
                ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                ctx.drawImage(img, 0, 0);
                updateHistoryButtons();
                localStorage.setItem('yos1k_paint_local', img.src);
            };
            img.src = history[historyIdx];
        }

        function updateHistoryButtons() {
            elements.undo.disabled = historyIdx <= 0;
            elements.redo.disabled = historyIdx >= history.length - 1;
        }

        const getPos = (e) => {
            const r = elements.canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return { x: touch.clientX - r.left, y: touch.clientY - r.top };
        };

        function startDrawing(e) {
            const {x, y} = getPos(e);

            if (currentTool === 'scissors') {
                if (movingImageData) {
                    // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≤—ã—Ä–µ–∑–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç, –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                    isMoving = true;
                    dragOffset = { x: x - selectionRect.x, y: y - selectionRect.y };
                } else {
                    // –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    selectionRect = { x, y, w: 0, h: 0 };
                    isDrawing = true;
                }
                return;
            }

            if (currentTool === 'object' && selectedObject) {
                drawObject(x, y);
                saveToHistory();
                return;
            }
            
            if (currentTool === 'text') {
                drawText(x, y);
                saveToHistory();
                return;
            }

            if (currentTool === 'bucket') {
                floodFill(Math.floor(x), Math.floor(y), elements.color.value);
                saveToHistory();
                return;
            }
            
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.strokeStyle = elements.color.value;
            ctx.lineWidth = parseInt(elements.size.value);
            ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
        }

        function draw(e) {
            const {x, y} = getPos(e);

            if (currentTool === 'scissors') {
                if (isMoving && movingImageData) {
                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ–±—ä–µ–∫—Ç
                    selectionRect.x = x - dragOffset.x;
                    selectionRect.y = y - dragOffset.y;
                    renderMovingObject();
                    return;
                }
                if (isDrawing && selectionRect) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–º–∫—É –≤—ã–¥–µ–ª–µ–Ω–∏—è
                    selectionRect.w = x - selectionRect.x;
                    selectionRect.h = y - selectionRect.y;
                    drawSelectionFrame();
                    return;
                }
            }

            if (!isDrawing) return;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            if (currentTool === 'scissors') {
                if (isMoving) {
                    isMoving = false;
                    // –ú—ã –Ω–µ "–ø—Ä–∏–∫–ª–µ–∏–≤–∞–µ–º" –æ–±—ä–µ–∫—Ç —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–≤–∏–≥–∞—Ç—å –¥–∞–ª—å—à–µ. 
                    // –ü—Ä–∏–∫–ª–µ–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.
                } else if (isDrawing && selectionRect) {
                    isDrawing = false;
                    // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–±–æ—Ä–∫—É
                    if (Math.abs(selectionRect.w) > 5 && Math.abs(selectionRect.h) > 5) {
                        captureSelection();
                    } else {
                        selectionRect = null;
                        sCtx.clearRect(0, 0, elements.selectionCanvas.width, elements.selectionCanvas.height);
                    }
                }
                return;
            }

            if (!isDrawing) return;
            ctx.closePath();
            isDrawing = false;
            saveToHistory();
        }

        function drawSelectionFrame() {
            sCtx.clearRect(0, 0, elements.selectionCanvas.width, elements.selectionCanvas.height);
            sCtx.setLineDash([5, 5]);
            sCtx.strokeStyle = '#facc15';
            sCtx.lineWidth = 2;
            sCtx.strokeRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
        }

        function captureSelection() {
            // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
            if (selectionRect.w < 0) { selectionRect.x += selectionRect.w; selectionRect.w = Math.abs(selectionRect.w); }
            if (selectionRect.h < 0) { selectionRect.y += selectionRect.h; selectionRect.h = Math.abs(selectionRect.h); }

            // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –ø–∏–∫—Å–µ–ª–∏
            movingImageData = ctx.getImageData(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
            
            // –£–¥–∞–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª —Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ö–æ–ª—Å—Ç–∞
            ctx.clearRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
            
            renderMovingObject();
        }

        function renderMovingObject() {
            sCtx.clearRect(0, 0, elements.selectionCanvas.width, elements.selectionCanvas.height);
            if (!movingImageData) return;
            
            // –†–∏—Å—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–º —Ö–æ–ª—Å—Ç–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = selectionRect.w;
            tempCanvas.height = selectionRect.h;
            tempCanvas.getContext('2d').putImageData(movingImageData, 0, 0);
            
            sCtx.drawImage(tempCanvas, selectionRect.x, selectionRect.y);
            
            // –†–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥
            sCtx.setLineDash([2, 2]);
            sCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            sCtx.strokeRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
        }

        function applyMovingObject() {
            if (movingImageData && selectionRect) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = selectionRect.w;
                tempCanvas.height = selectionRect.h;
                tempCanvas.getContext('2d').putImageData(movingImageData, 0, 0);
                
                ctx.globalCompositeOperation = 'source-over';
                ctx.drawImage(tempCanvas, selectionRect.x, selectionRect.y);
                
                movingImageData = null;
                selectionRect = null;
                sCtx.clearRect(0, 0, elements.selectionCanvas.width, elements.selectionCanvas.height);
                saveToHistory();
            }
        }

        function drawText(x, y) {
            const text = elements.textInput.value || "Yos1k";
            ctx.globalCompositeOperation = 'source-over';
            ctx.font = `bold ${elements.size.value * 2}px sans-serif`;
            ctx.fillStyle = elements.color.value;
            ctx.textAlign = 'center';
            ctx.fillText(text, x, y);
        }

        function drawObject(x, y) {
            const size = parseInt(elements.size.value) * 2;
            ctx.globalCompositeOperation = 'source-over';
            if (selectedObject.type === 'emoji') {
                ctx.font = `${size}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(selectedObject.value, x, y);
            } else {
                const img = selectedObject.value;
                const aspect = img.width / img.height;
                let w = size, h = size;
                if (aspect > 1) h = size / aspect; else w = size * aspect;
                ctx.drawImage(img, x - w/2, y - h/2, w, h);
            }
        }

        function floodFill(startX, startY, fillHex) {
            const img = ctx.getImageData(0, 0, elements.canvas.width, elements.canvas.height);
            const startIdx = (startY * img.width + startX) * 4;
            const startR = img.data[startIdx], startG = img.data[startIdx+1], startB = img.data[startIdx+2], startA = img.data[startIdx+3];
            
            const r = parseInt(fillHex.slice(1,3), 16);
            const g = parseInt(fillHex.slice(3,5), 16);
            const b = parseInt(fillHex.slice(5,7), 16);

            if (startR === r && startG === g && startB === b && startA === 255) return;

            const stack = [[startX, startY]];
            while(stack.length) {
                const [cx, cy] = stack.pop();
                if (cx < 0 || cx >= img.width || cy < 0 || cy >= img.height) continue;
                const idx = (cy * img.width + cx) * 4;
                if (img.data[idx] === startR && img.data[idx+1] === startG && img.data[idx+2] === startB && img.data[idx+3] === startA) {
                    img.data[idx] = r; img.data[idx+1] = g; img.data[idx+2] = b; img.data[idx+3] = 255;
                    stack.push([cx-1, cy], [cx+1, cy], [cx, cy-1], [cx, cy+1]);
                }
            }
            ctx.putImageData(img, 0, 0);
        }

        // --- –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –ò –°–û–ë–´–¢–ò–Ø ---

        elements.canvas.onmousedown = startDrawing;
        window.onmousemove = draw;
        window.onmouseup = stopDrawing;

        // –°–µ–Ω—Å–æ—Ä–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
        const handleTouch = (e, fn) => {
            const r = elements.canvas.getBoundingClientRect();
            const touch = e.touches[0];
            if (touch) fn({ clientX: touch.clientX, clientY: touch.clientY });
        };
        elements.canvas.ontouchstart = (e) => { e.preventDefault(); handleTouch(e, startDrawing); };
        elements.canvas.ontouchmove = (e) => { e.preventDefault(); handleTouch(e, draw); };
        elements.canvas.ontouchend = (e) => { e.preventDefault(); stopDrawing(); };

        elements.undo.onclick = () => { applyMovingObject(); undo(); };
        elements.redo.onclick = () => { applyMovingObject(); redo(); };
        elements.clear.onclick = () => { 
            applyMovingObject();
            ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height); 
            saveToHistory(); 
        };

        elements.size.oninput = (e) => elements.sizeDisplay.innerText = `–†–∞–∑–º–µ—Ä: ${e.target.value}px`;

        ['brush', 'eraser', 'bucket', 'text', 'scissors'].forEach(tool => {
            document.getElementById(`${tool}Btn`).onclick = () => {
                if (currentTool === 'scissors') applyMovingObject();
                
                currentTool = tool;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.object-item').forEach(b => b.classList.remove('selected'));
                document.getElementById(`${tool}Btn`).classList.add('active');
                elements.textInputWrap.classList.toggle('hidden', tool !== 'text');
            };
        });

        elements.musicUpload.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                elements.audio.src = URL.createObjectURL(file);
                elements.audio.play();
                updatePlayIcon();
            }
        };
        elements.musicToggle.onclick = () => {
            if (elements.audio.paused) elements.audio.play(); else elements.audio.pause();
            updatePlayIcon();
        };
        elements.musicVol.oninput = (e) => elements.audio.volume = e.target.value;
        function updatePlayIcon() {
            elements.playIcon.innerHTML = elements.audio.paused 
                ? '<path d="M8 5v14l11-7z"/>' 
                : '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
        }

        function selectObj(type, value, el) {
            if (currentTool === 'scissors') applyMovingObject();
            currentTool = 'object';
            selectedObject = {type, value};
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.object-item').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        document.querySelectorAll('.object-item').forEach(item => {
            item.onclick = () => selectObj(item.dataset.type, item.dataset.value, item);
        });

        elements.objectUpload.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = () => {
                        const div = document.createElement('div');
                        div.className = 'object-item';
                        div.innerHTML = `<img src="${img.src}" class="w-8 h-8 object-contain">`;
                        div.onclick = () => selectObj('image', img, div);
                        elements.objectsContainer.prepend(div);
                        selectObj('image', img, div);
                    };
                };
                reader.readAsDataURL(file);
            }
        };

        // –°–û–•–†–ê–ù–ï–ù–ò–ï –° –ë–ï–õ–´–ú –§–û–ù–û–ú
        elements.save.onclick = () => {
            applyMovingObject();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = elements.canvas.width;
            tempCanvas.height = elements.canvas.height;
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(elements.canvas, 0, 0);
            const link = document.createElement('a');
            link.download = 'yos1k-paint.png';
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        };
    </script>
</body>
</html>
