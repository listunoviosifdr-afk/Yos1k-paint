<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yos1k Paint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Анимации интерфейса */
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9) translateY(40px); filter: blur(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes starsMove {
            from { background-position: 0 0, 40px 60px, 130px 270px; }
            to { background-position: 1000px 1000px, 1040px 1060px, 1130px 1270px; }
        }

        @keyframes pulseBorder {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        @keyframes avatarGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(250, 204, 21, 0.3); border-color: rgba(250, 204, 21, 0.5); }
            50% { box-shadow: 0 0 40px rgba(250, 204, 21, 0.6); border-color: rgba(250, 204, 21, 0.9); }
        }

        @keyframes discordBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        * { 
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); 
        }

        body {
            background-color: #020617;
            touch-action: none;
            font-family: ui-sans-serif, system-ui, sans-serif;
            margin: 0;
            overflow: hidden;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0));
            background-size: 200px 200px;
            animation: starsMove 60s linear infinite;
        }

        /* КУРСОР КИСТИ */
        #brushCursor {
            position: fixed;
            pointer-events: none;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            mix-blend-mode: difference;
            z-index: 9999;
            display: none;
            transform: translate(-50%, -50%);
            transition: none;
        }

        .canvas-container {
            position: relative;
            background-color: #ffffff;
            /* СЕТКА ФОНА */
            background-image: 
                linear-gradient(45deg, #e5e7eb 25%, transparent 25%), 
                linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #e5e7eb 75%), 
                linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            border: 4px solid rgba(255, 255, 255, 0.1);
            animation: zoomIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: none;
            overflow: visible; 
        }

        canvas { image-rendering: auto; border-radius: 12px; }

        #paintCanvas {
            position: relative;
            z-index: 10;
            background: transparent;
        }

        #floatingPreview {
            position: absolute;
            z-index: 45;
            display: none;
            opacity: 0.9;
            border: 2px dashed #facc15;
            transform: translate(-50%, -50%);
            transition: none;
            will-change: left, top;
            cursor: grab;
            pointer-events: auto;
        }
        #floatingPreview:active { cursor: grabbing; }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #facc15;
            border: 2px solid #ef4444;
            border-radius: 50%;
            z-index: 55;
            pointer-events: auto;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        #selectionBox {
            position: absolute;
            border: 2px dashed #facc15;
            background: rgba(250, 204, 21, 0.2);
            display: none;
            pointer-events: none;
            z-index: 40;
            transition: none;
        }

        #objectResizeHandles {
            position: absolute;
            pointer-events: none;
            z-index: 50;
            display: none;
            border: 2px dashed #facc15;
            transform: translate(-50%, -50%);
            transition: none;
        }

        #welcomeScreen {
            z-index: 100;
            background: linear-gradient(180deg, #dc2626 0%, #facc15 100%);
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.6s;
        }

        #welcomeScreen.app-hidden {
            opacity: 0;
            visibility: hidden;
            transform: scale(1.1);
            pointer-events: none;
        }

        .corner-avatar {
            position: fixed;
            top: 24px;
            left: 24px;
            width: 80px;
            height: 80px;
            border-radius: 9999px;
            border: 3px solid #facc15;
            animation: avatarGlow 3s ease-in-out infinite;
            z-index: 110;
            transition: transform 0.3s;
        }
        
        .corner-avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        /* ДИСКОРД КНОПКА */
        .discord-link {
            position: fixed;
            bottom: 32px;
            left: 32px;
            width: 60px;
            height: 60px;
            background: transparent;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 110;
            animation: discordBounce 4s ease-in-out infinite;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .discord-link svg {
            fill: #000000;
            filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.2));
        }

        .discord-link:hover {
            transform: scale(1.15) rotate(-5deg);
        }

        .discord-link:active {
            transform: scale(0.9);
        }

        .tool-btn {
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; border-radius: 12px;
            color: #ffffff; cursor: pointer;
            position: relative;
            background: transparent;
        }
        
        .tool-btn:not(:disabled):hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .tool-btn:active {
            transform: scale(0.9);
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #ef4444 0%, #facc15 100%);
            color: white; 
            transform: scale(1.1);
            animation: pulseBorder 2s infinite;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(32px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeInUp 0.6s ease-out;
        }

        .setting-label {
            font-size: 11px;
            font-weight: 900;
            color: #ffffff;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.08em;
            display: block; 
            width: 100%;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        select, input[type="text"], input[type="number"] {
            background: #0f172a !important; 
            color: #ffffff !important; 
            border: 2px solid rgba(250, 204, 21, 0.4) !important;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 14px;      
            font-weight: 900;
            outline: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            appearance: none;
        }

        select option {
            background: #0f172a;
            color: #ffffff !important;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            filter: invert(1);
        }

        #brushSizeInput {
            width: 80px;
            text-align: center;
        }

        #visualizer { height: 32px; width: 60px; display: flex; align-items: center; gap: 2px; }
        .vis-bar { flex: 1; height: 4px; background: #facc15; border-radius: 4px; transition: height 0.05s ease-out; }

        #objectTable {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 60;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(24px);
            border: 2px solid #facc15;
            border-radius: 24px;
            padding: 16px;
            width: 220px; 
            max-height: 85vh;
            box-shadow: 0 25px 60px rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
            overflow: visible; 
        }
        
        .lib-header-text {
            font-size: 12px;
            font-weight: 900;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-align: center;
            width: 100%;
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(250, 204, 21, 0.5);
            display: block;
            word-wrap: break-word;
            line-height: 1.4;
            overflow: visible;
        }

        .lib-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 4px;
            max-height: calc(100vh - 350px);
            overflow-y: auto;
            padding: 4px;
            scrollbar-width: thin;
            scrollbar-color: #facc15 transparent;
        }

        .lib-item-mini {
            aspect-ratio: 1;
            background: white;
            border-radius: 14px;
            cursor: pointer;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .lib-item-mini img {
            max-width: 85%;
            max-height: 85%;
            object-fit: contain;
        }

        .delete-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: #ef4444;
            color: white;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom-left-radius: 8px;
            opacity: 0;
            z-index: 10;
        }

        .lib-item-mini:hover { transform: scale(1.05); border-color: #facc15; }
        .lib-item-mini:hover .delete-btn { opacity: 1; }

        input[type="range"] { 
            -webkit-appearance: none; 
            cursor: pointer; 
            background: rgba(255,255,255,0.2); 
            border-radius: 8px; 
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: #facc15;
            border: 2px solid #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        #pasteModal {
            position: fixed; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(12px);
            display: none; align-items: center; justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        #pasteModal.show {
            display: flex;
            opacity: 1;
        }

        .paste-card {
            background: #1e293b; border: 2px solid #facc15;
            padding: 32px; border-radius: 24px; text-align: center;
            max-width: 320px; width: 90%;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #pasteModal.show .paste-card {
            transform: scale(1) translateY(0);
        }

        .action-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 0;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 8px;
        }
        .action-button:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }

        .history-btn:disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }

        #audioSettingsMenu {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(250, 204, 21, 0.3);
            border-radius: 16px;
            padding: 16px;
            width: 220px;
            display: none;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            z-index: 100;
        }

        #audioSettingsMenu.show {
            display: flex;
            animation: fadeInUp 0.3s ease-out;
        }

        /* Кнопка замка */
        .lock-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(250, 204, 21, 0.4);
            border-radius: 8px;
            color: rgba(250, 204, 21, 0.4);
            cursor: pointer;
            margin-top: 18px;
            transition: all 0.2s;
        }
        .lock-btn.active {
            color: #facc15;
            border-color: #facc15;
            background: rgba(250, 204, 21, 0.1);
        }

    </style>
</head>
<body class="flex flex-col h-screen w-screen overflow-hidden">

    <!-- КУРСОР КИСТИ -->
    <div id="brushCursor"></div>

    <!-- Модальное окно вставки -->
    <div id="pasteModal">
        <div class="paste-card shadow-2xl">
            <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#facc15" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
            </div>
            <h3 class="text-white text-xl font-bold mb-2">Найдено изображение</h3>
            <p class="text-slate-400 text-sm mb-6">Выберите режим вставки</p>
            <div class="flex flex-col gap-3">
                <button id="pasteAsObject" class="bg-yellow-500 text-black font-black py-3 rounded-xl hover:brightness-110">Как объект</button>
                <button id="pasteAsBackground" class="bg-slate-700 text-white font-bold py-3 rounded-xl hover:brightness-110">Как фон</button>
                <button id="cancelPaste" class="text-slate-500 text-sm mt-2 hover:text-white transition-colors">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Начальный экран -->
    <div id="welcomeScreen">
        <!-- Аватарка Йосика -->
        <img id="welcomeAvatar" src="https://yt3.googleusercontent.com/E51f-Ku1QqArwy4dqPzwugfJRSQYK2cCEmSS1QFSJm9epWo3qIP7iRcHkjQJLPfhIoliAzHroA=s900-c-k-c0x00ffffff-no-rj" alt="Yos1k" class="corner-avatar">
        
        <!-- КНОПКА ДИСКОРД -->
        <a href="https://discord.gg/dJDp5P3fsT" target="_blank" class="discord-link" title="Наш Discord">
            <svg width="32" height="32" viewBox="0 0 127.14 96.36">
                <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.71,32.65-1.82,56.6.4,80.21a105.73,105.73,0,0,0,32.17,16.15,77.7,77.7,0,0,0,6.89-11.11,68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1,105.25,105.25,0,0,0,32.19-16.14c2.72-27.09-4.5-50.84-19.41-72.13ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
            </svg>
        </a>

        <div class="p-12 rounded-[3.5rem] text-center max-w-lg mx-4 border border-white/10 bg-black/40 backdrop-blur-3xl shadow-2xl">
             <!-- Убрано 1.1 -->
             <h1 class="text-7xl font-black mb-4 text-white" style="background: linear-gradient(to right, #ef4444, #facc15); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Yos1k paint</h1>
             
             <a href="https://www.youtube.com/@yos1kGD" target="_blank" class="flex items-center justify-center gap-3 mb-12 hover:scale-110 active:scale-95 transition-transform group">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="#FF0000">
                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                <span class="text-white text-2xl font-black tracking-wider group-hover:text-yellow-400 transition-colors">Yos1kGD</span>
             </a>

             <button id="quickEnterBtn" class="w-full bg-gradient-to-r from-red-600 to-yellow-500 text-white text-xl font-black py-6 rounded-2xl uppercase tracking-widest shadow-lg hover:shadow-yellow-500/20 active:scale-95 transition-all">
                Открыть холст
             </button>
        </div>
    </div>

    <!-- Основное приложение -->
    <div id="mainApp" class="flex flex-col h-full w-full opacity-0 pointer-events-none scale-95 transition-all duration-700">
        <div class="glass-panel px-6 py-3 flex items-center z-50 flex-wrap gap-4 shadow-xl">
            <div class="flex items-center gap-4">
                <input type="color" id="colorPicker" value="#ef4444" class="w-12 h-12 cursor-pointer rounded-xl bg-transparent border-0 hover:scale-110 transition-transform">
                
                <div id="brushSizeSection" class="flex flex-col w-44">
                    <span class="setting-label text-center">Размер</span>
                    <input type="range" id="brushSize" min="1" max="1000" value="50" class="h-2 bg-slate-700 rounded-lg accent-yellow-400 mb-2">
                    <div class="flex items-center justify-center gap-2">
                        <input type="number" id="brushSizeInput" value="50" min="1" max="1000">
                        <span class="text-white font-black text-xs uppercase" style="text-shadow: 0 2px 4px black">px</span>
                    </div>
                </div>

                <!-- КОНТРОЛЛЫ РАЗМЕРА ОБЪЕКТА -->
                <div id="objectSizeSection" class="hidden flex items-center gap-4">
                    <div class="flex flex-col items-center">
                        <span class="setting-label text-center">Ширина (X)</span>
                        <input type="number" id="objWidthInput" value="100" min="1" max="2000" class="w-20">
                    </div>
                    
                    <button id="lockSizeBtn" class="lock-btn" title="Заблокировать пропорции">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </button>

                    <div class="flex flex-col items-center">
                        <span class="setting-label text-center">Высота (Y)</span>
                        <input type="number" id="objHeightInput" value="100" min="1" max="2000" class="w-20">
                    </div>
                    <button id="finishObjectBtn" class="h-10 px-6 bg-green-500 text-white font-black rounded-xl hover:bg-green-600 active:scale-95 transition-all">ГОТОВО</button>
                </div>

                <div id="modePanel" class="flex flex-col items-center">
                    <span class="setting-label text-center">Режим</span>
                    <select id="brushMode" class="h-10">
                        <option value="normal">Обычная</option>
                        <option value="pixel">Пиксели</option>
                        <option value="glow">Неон</option>
                        <option value="rainbow">Радуга</option>
                    </select>
                </div>

                <div id="textToolSettings" class="flex items-center gap-4 hidden">
                    <div class="flex flex-col">
                        <span class="setting-label text-center">Шрифт</span>
                        <select id="fontPicker" class="h-10">
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times</option>
                            <option value="Courier New">Courier</option>
                            <option value="Impact">Impact</option>
                            <option value="Verdana">Verdana</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <span class="setting-label text-center">Текст</span>
                        <input type="text" id="textInput" placeholder="Привет!" class="w-32 h-10">
                    </div>
                </div>

                <div class="flex bg-white/5 p-1 rounded-2xl gap-1 border border-white/10 shadow-inner">
                    <button id="undoBtn" class="tool-btn history-btn" title="Назад" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                    </button>
                    <button id="redoBtn" class="tool-btn history-btn" title="Вперед" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/></svg>
                    </button>
                </div>

                <div class="flex bg-white/5 p-1 rounded-2xl gap-1 border border-white/10 shadow-inner">
                    <button id="brushBtn" class="tool-btn active" title="Кисть"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg></button>
                    <button id="textBtn" class="tool-btn" title="Текст"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg></button>
                    <button id="waveBtn" class="tool-btn" title="Волна">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M2 6c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                            <path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                            <path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                        </svg>
                    </button>
                    <button id="scissorsBtn" class="tool-btn" title="Вырезать"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg></button>
                    <button id="bucketBtn" class="tool-btn" title="Заливка"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m19 11-8-8-8.6 8.6a2 2 0 0 0 0 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11Z"/><path d="M2 13h15"/></svg></button>
                    <button id="eraserBtn" class="tool-btn" title="Ластик"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/></svg></button>
                </div>

                <div class="relative flex items-center gap-2 bg-white/5 p-2 rounded-2xl border border-white/10 shadow-inner">
                    <button id="musicToggle" class="text-white hover:text-yellow-400 transition-colors">
                        <svg id="playIcon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <div id="visualizer">
                        <div class="vis-bar"></div><div class="vis-bar"></div><div class="vis-bar"></div><div class="vis-bar"></div><div class="vis-bar"></div><div class="vis-bar"></div>
                    </div>
                    <button id="loadMusicBtn" class="tool-btn !w-auto px-4 h-10 gap-2 bg-white/10 hover:bg-white/20 border border-white/10">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#facc15" stroke-width="2.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                        <span class="text-[10px] font-black text-white">MP3</span>
                    </button>
                    <button id="audioSettingsBtn" class="tool-btn !w-10 !h-10 text-white hover:text-yellow-400" title="Настройки звука">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </button>

                    <div id="audioSettingsMenu">
                        <div class="flex flex-col">
                            <span class="setting-label text-center">Громкость</span>
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" class="w-full">
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center mb-1">
                                <span class="setting-label !w-auto">Скорость</span>
                                <span id="speedValue" class="text-[11px] text-yellow-500 font-bold">1.0x</span>
                            </div>
                            <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1.0" class="w-full">
                        </div>
                        <div class="flex flex-col">
                            <span class="setting-label text-center">Перемотка</span>
                            <input type="range" id="offsetSlider" min="0" max="100" step="1" value="0" class="w-full">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="canvasWrapper" class="relative flex-grow flex items-center justify-center p-4 overflow-hidden bg-slate-950">
            <!-- ПАНЕЛЬ ОБЪЕКТОВ -->
            <div id="objectTable">
                <span class="lib-header-text">Библиотека объектов</span>
                <div class="lib-grid" id="libGrid">
                    <div class="lib-item-mini shadow-lg" onclick="insertObject('https://yt3.googleusercontent.com/E51f-Ku1QqArwy4dqPzwugfJRSQYK2cCEmSS1QFSJm9epWo3qIP7iRcHkjQJLPfhIoliAzHroA=s900-c-k-c0x00ffffff-no-rj')">
                        <img src="https://yt3.googleusercontent.com/E51f-Ku1QqArwy4dqPzwugfJRSQYK2cCEmSS1QFSJm9epWo3qIP7iRcHkjQJLPfhIoliAzHroA=s900-c-k-c0x00ffffff-no-rj">
                    </div>
                    <div id="uploadObjectBtn" class="lib-item-mini border-dashed border-yellow-500/50 bg-yellow-500/10 text-yellow-500 shadow-lg group hover:bg-yellow-500/20">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </div>
                </div>

                <div class="mt-4 flex flex-col gap-1">
                    <button id="clearBtn" class="action-button bg-red-500/20 hover:bg-red-500/40 !text-red-400 border-red-500/30">Очистить</button>
                    <button id="saveBtn" class="action-button bg-yellow-500/20 hover:bg-yellow-500/40 !text-yellow-400 border-yellow-500/30">Сохранить</button>
                </div>
            </div>

            <div class="canvas-container" id="container">
                <canvas id="paintCanvas"></canvas>
                
                <!-- ОБЛАСТЬ ВЫДЕЛЕНИЯ -->
                <div id="selectionBox">
                    <div class="resize-handle" style="top: -6px; left: -6px;"></div>
                    <div class="resize-handle" style="top: -6px; left: 50%; transform: translateX(-50%);"></div>
                    <div class="resize-handle" style="top: -6px; right: -6px;"></div>
                    <div class="resize-handle" style="top: 50%; left: -6px; transform: translateY(-50%);"></div>
                    <div class="resize-handle" style="top: 50%; right: -6px; transform: translateY(-50%);"></div>
                    <div class="resize-handle" style="bottom: -6px; left: -6px;"></div>
                    <div class="resize-handle" style="bottom: -6px; left: 50%; transform: translateX(-50%);"></div>
                    <div class="resize-handle" style="bottom: -6px; right: -6px;"></div>
                </div>

                <!-- КОНТЕЙНЕР ДЛЯ РЕЖИМА ВСТАВКИ/ПЕРЕМЕЩЕНИЯ -->
                <div id="objectResizeHandles">
                    <div class="resize-handle" data-h="nw" style="top: -6px; left: -6px; cursor: nw-resize;"></div>
                    <div class="resize-handle" data-h="n"  style="top: -6px; left: 50%; transform: translateX(-50%); cursor: n-resize;"></div>
                    <div class="resize-handle" data-h="ne" style="top: -6px; right: -6px; cursor: ne-resize;"></div>
                    <div class="resize-handle" data-h="w"  style="top: 50%; left: -6px; transform: translateY(-50%); cursor: w-resize;"></div>
                    <div class="resize-handle" data-h="e"  style="top: 50%; right: -6px; transform: translateY(-50%); cursor: e-resize;"></div>
                    <div class="resize-handle" data-h="sw" style="bottom: -6px; left: -6px; cursor: sw-resize;"></div>
                    <div class="resize-handle" data-h="s"  style="bottom: -6px; left: 50%; transform: translateX(-50%); cursor: s-resize;"></div>
                    <div class="resize-handle" data-h="se" style="bottom: -6px; right: -6px; cursor: se-resize;"></div>
                </div>

                <canvas id="floatingPreview"></canvas>
            </div>
        </div>
    </div>

    <input type="file" id="objectFile" accept="image/*" class="hidden">
    <input type="file" id="musicInput" accept="audio/*" class="hidden">
    <audio id="audioElement" loop crossorigin="anonymous"></audio>

    <script>
        const elements = {
            welcome: document.getElementById('welcomeScreen'),
            enterBtn: document.getElementById('quickEnterBtn'),
            main: document.getElementById('mainApp'),
            canvas: document.getElementById('paintCanvas'),
            container: document.getElementById('container'),
            wrapper: document.getElementById('canvasWrapper'),
            color: document.getElementById('colorPicker'),
            size: document.getElementById('brushSize'),
            sizeInput: document.getElementById('brushSizeInput'),
            brushMode: document.getElementById('brushMode'),
            modePanel: document.getElementById('modePanel'),
            textToolSettings: document.getElementById('textToolSettings'),
            textInput: document.getElementById('textInput'),
            fontPicker: document.getElementById('fontPicker'),
            clear: document.getElementById('clearBtn'),
            save: document.getElementById('saveBtn'),
            undo: document.getElementById('undoBtn'),
            redo: document.getElementById('redoBtn'),
            audio: document.getElementById('audioElement'),
            musicToggle: document.getElementById('musicToggle'),
            loadMusicBtn: document.getElementById('loadMusicBtn'),
            audioSettingsBtn: document.getElementById('audioSettingsBtn'),
            audioSettingsMenu: document.getElementById('audioSettingsMenu'),
            speedSlider: document.getElementById('speedSlider'),
            speedValue: document.getElementById('speedValue'),
            offsetSlider: document.getElementById('offsetSlider'),
            playIcon: document.getElementById('playIcon'),
            selectionBox: document.getElementById('selectionBox'),
            objectResizeHandles: document.getElementById('objectResizeHandles'),
            floatingPreview: document.getElementById('floatingPreview'),
            visBars: document.querySelectorAll('.vis-bar'),
            objectFile: document.getElementById('objectFile'),
            musicInput: document.getElementById('musicInput'),
            uploadObjectBtn: document.getElementById('uploadObjectBtn'),
            volume: document.getElementById('volumeSlider'),
            libGrid: document.getElementById('libGrid'),
            pasteModal: document.getElementById('pasteModal'),
            pasteAsObject: document.getElementById('pasteAsObject'),
            pasteAsBackground: document.getElementById('pasteAsBackground'),
            cancelPaste: document.getElementById('cancelPaste'),
            brushCursor: document.getElementById('brushCursor'),
            objWidthInput: document.getElementById('objWidthInput'),
            objHeightInput: document.getElementById('objHeightInput'),
            objectSizeSection: document.getElementById('objectSizeSection'),
            brushSizeSection: document.getElementById('brushSizeSection'),
            finishObjectBtn: document.getElementById('finishObjectBtn'),
            lockSizeBtn: document.getElementById('lockSizeBtn')
        };

        const ctx = elements.canvas.getContext('2d', { willReadFrequently: true });
        const floatCtx = elements.floatingPreview.getContext('2d');

        const glowCanvas = document.createElement('canvas');
        const gctx = glowCanvas.getContext('2d');
        
        let audioCtx, analyzer, dataArray, sourceNode;
        let isProportionsLocked = false;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyzer = audioCtx.createAnalyser();
            analyzer.fftSize = 64; 
            sourceNode = audioCtx.createMediaElementSource(elements.audio);
            sourceNode.connect(analyzer);
            analyzer.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyzer.frequencyBinCount);
        }

        function updateGlowTexture(color, size) {
            const diam = size * 3; 
            glowCanvas.width = Math.max(1, diam);
            glowCanvas.height = Math.max(1, diam);
            const center = diam / 2;
            const grad = gctx.createRadialGradient(center, center, 0, center, center, center);
            
            let r=255, g=255, b=255;
            if (color.startsWith('#')) {
                r = parseInt(color.slice(1, 3), 16);
                g = parseInt(color.slice(3, 5), 16);
                b = parseInt(color.slice(5, 7), 16);
            }

            grad.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.35)`);
            grad.addColorStop(0.3, `rgba(${r}, ${g}, ${b}, 0.2)`);
            grad.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);

            gctx.clearRect(0,0, diam, diam);
            gctx.fillStyle = grad;
            gctx.fillRect(0,0, diam, diam);
        }

        let isDrawing = false, currentTool = 'brush', lastPos = { x: 0, y: 0 }, hue = 0, history = [], historyIdx = -1;
        let mouse = { x: 0, y: 0, targetX: 0, targetY: 0 }, objectPos = { x: 0, y: 0 };
        let customLibrary = JSON.parse(localStorage.getItem('yos1k_paint_lib') || '[]');
        let activeLibraryImg = null; 
        let selectedImageData = null, isMovingSelection = false, selectionStart = null, pastedImageBuffer = null;

        let isDraggingObject = false;
        let isResizingObject = false;
        let activeHandle = '';
        let dragOffset = { x: 0, y: 0 };
        let resizeStart = { w: 0, h: 0, mx: 0, my: 0 };

        function saveLibrary() {
            localStorage.setItem('yos1k_paint_lib', JSON.stringify(customLibrary));
            renderLibrary();
        }

        function renderLibrary() {
            elements.libGrid.querySelectorAll('.custom-lib-item').forEach(i => i.remove());
            customLibrary.forEach((data, index) => {
                const div = document.createElement('div');
                div.className = 'lib-item-mini shadow-lg custom-lib-item';
                div.innerHTML = `<img src="${data}"><div class="delete-btn" onclick="deleteFromLib(event, ${index})">✕</div>`;
                div.onclick = () => insertObject(data);
                elements.libGrid.insertBefore(div, elements.uploadObjectBtn);
            });
        }

        window.deleteFromLib = (e, index) => {
            e.stopPropagation(); customLibrary.splice(index, 1); saveLibrary();
        };

        function addToLibrary(url) {
            customLibrary.unshift(url); if (customLibrary.length > 30) customLibrary.pop(); saveLibrary();
        }

        function lerp(start, end, amt) { return (1 - amt) * start + amt * end; }

        function saveState() {
            if (historyIdx < history.length - 1) {
                history = history.slice(0, historyIdx + 1);
            }
            history.push(ctx.getImageData(0, 0, elements.canvas.width, elements.canvas.height));
            if (history.length > 50) history.shift();
            else historyIdx++;
            updateHistoryButtons();
        }

        function undo() {
            if (historyIdx > 0) {
                historyIdx--;
                ctx.clearRect(0,0,elements.canvas.width, elements.canvas.height);
                ctx.putImageData(history[historyIdx], 0, 0);
                updateHistoryButtons();
            }
        }

        function redo() {
            if (historyIdx < history.length - 1) {
                historyIdx++;
                ctx.clearRect(0,0,elements.canvas.width, elements.canvas.height);
                ctx.putImageData(history[historyIdx], 0, 0);
                updateHistoryButtons();
            }
        }

        function updateHistoryButtons() {
            elements.undo.disabled = (historyIdx <= 0);
            elements.redo.disabled = (historyIdx >= history.length - 1);
        }

        elements.enterBtn.addEventListener('click', () => {
            elements.welcome.classList.add('app-hidden');
            elements.main.classList.remove('pointer-events-none', 'opacity-0', 'scale-95');
            elements.main.classList.add('opacity-100', 'scale-100');
            setTimeout(initCanvas, 300);
            renderLibrary();
        });

        function initCanvas() {
            const w = Math.floor(elements.wrapper.clientWidth * 0.95);
            const h = Math.floor(elements.wrapper.clientHeight * 0.95);
            elements.canvas.width = w; 
            elements.canvas.height = h;
            ctx.clearRect(0, 0, w, h);
            history = []; historyIdx = -1;
            saveState(); 
            requestAnimationFrame(smoothUpdate);
        }

        function updateObjectScale() {
            if (!activeLibraryImg && !selectedImageData) return;
            const w = parseInt(elements.objWidthInput.value) || 100;
            const h = parseInt(elements.objHeightInput.value) || 100;
            
            elements.floatingPreview.width = w;
            elements.floatingPreview.height = h;
            floatCtx.clearRect(0,0,w,h);
            
            if (activeLibraryImg) {
                floatCtx.drawImage(activeLibraryImg, 0, 0, w, h);
            } else if (selectedImageData) {
                const temp = document.createElement('canvas');
                temp.width = selectedImageData.width;
                temp.height = selectedImageData.height;
                temp.getContext('2d').putImageData(selectedImageData, 0, 0);
                floatCtx.drawImage(temp, 0, 0, w, h);
            }
        }

        // ЛОГИКА ЗАМКА
        elements.lockSizeBtn.addEventListener('click', () => {
            isProportionsLocked = !isProportionsLocked;
            elements.lockSizeBtn.classList.toggle('active', isProportionsLocked);
            if (isProportionsLocked) {
                elements.objHeightInput.value = elements.objWidthInput.value;
                updateObjectScale();
            }
        });

        elements.objWidthInput.addEventListener('input', () => {
            if (isProportionsLocked) elements.objHeightInput.value = elements.objWidthInput.value;
            updateObjectScale();
        });

        elements.objHeightInput.addEventListener('input', () => {
            if (isProportionsLocked) elements.objWidthInput.value = elements.objHeightInput.value;
            updateObjectScale();
        });

        function finishObjectPlacement() {
            if (!isMovingSelection) return;
            const w = parseInt(elements.objWidthInput.value);
            const h = parseInt(elements.objHeightInput.value);
            ctx.drawImage(elements.floatingPreview, objectPos.x - w/2, objectPos.y - h/2);
            isMovingSelection = false; 
            isDraggingObject = false;
            isResizingObject = false;
            elements.floatingPreview.style.display = 'none';
            elements.objectResizeHandles.style.display = 'none';
            activeLibraryImg = null; selectedImageData = null;
            elements.objectSizeSection.classList.add('hidden');
            elements.brushSizeSection.classList.remove('hidden');
            saveState();
        }

        elements.finishObjectBtn.addEventListener('click', finishObjectPlacement);

        function smoothUpdate() {
            mouse.x = lerp(mouse.x, mouse.targetX, 0.25);
            mouse.y = lerp(mouse.y, mouse.targetY, 0.25);
            
            const rect = elements.canvas.getBoundingClientRect();

            if (isResizingObject) {
                const dx = mouse.targetX - resizeStart.mx;
                const dy = mouse.targetY - resizeStart.my;
                
                let newW = resizeStart.w;
                let newH = resizeStart.h;

                if (activeHandle.includes('e')) newW = resizeStart.w + dx * 2;
                if (activeHandle.includes('w')) newW = resizeStart.w - dx * 2;
                if (activeHandle.includes('s')) newH = resizeStart.h + dy * 2;
                if (activeHandle.includes('n')) newH = resizeStart.h - dy * 2;

                if (isProportionsLocked) {
                    const side = Math.max(10, Math.max(newW, newH));
                    newW = side;
                    newH = side;
                } else {
                    newW = Math.max(10, newW);
                    newH = Math.max(10, newH);
                }

                elements.objWidthInput.value = Math.round(newW);
                elements.objHeightInput.value = Math.round(newH);
                updateObjectScale();
            } else if (isDraggingObject) {
                objectPos.x = mouse.targetX - dragOffset.x;
                objectPos.y = mouse.targetY - dragOffset.y;
            } else if (!isMovingSelection) {
                objectPos.x = lerp(objectPos.x, mouse.targetX, 0.12);
                objectPos.y = lerp(objectPos.y, mouse.targetY, 0.12);
            }
            
            const size = parseInt(elements.size.value);
            elements.brushCursor.style.width = size + 'px';
            elements.brushCursor.style.height = size + 'px';
            elements.brushCursor.style.left = (rect.left + mouse.targetX * (rect.width/elements.canvas.width)) + 'px';
            elements.brushCursor.style.top = (rect.top + mouse.targetY * (rect.height/elements.canvas.height)) + 'px';

            if (isMovingSelection) {
                const pxX = objectPos.x * (rect.width/elements.canvas.width);
                const pxY = objectPos.y * (rect.height/elements.canvas.height);
                elements.floatingPreview.style.left = `${pxX}px`;
                elements.floatingPreview.style.top = `${pxY}px`;
                
                elements.objectResizeHandles.style.display = 'block';
                elements.objectResizeHandles.style.left = `${pxX}px`;
                elements.objectResizeHandles.style.top = `${pxY}px`;
                elements.objectResizeHandles.style.width = (parseInt(elements.objWidthInput.value) * (rect.width/elements.canvas.width)) + 'px';
                elements.objectResizeHandles.style.height = (parseInt(elements.objHeightInput.value) * (rect.height/elements.canvas.height)) + 'px';
            } else {
                elements.objectResizeHandles.style.display = 'none';
            }

            if (analyzer && !elements.audio.paused) {
                analyzer.getByteFrequencyData(dataArray);
                if (elements.audio.duration) {
                    elements.offsetSlider.value = (elements.audio.currentTime / elements.audio.duration) * 100;
                }
                elements.visBars.forEach((bar, i) => {
                    const value = dataArray[i * 4] || 0;
                    const h = 4 + (value / 255) * 28;
                    bar.style.height = h + 'px';
                    bar.style.background = `rgb(250, ${204 - value/4}, ${21})`;
                });
            } else {
                elements.visBars.forEach(bar => bar.style.height = '4px');
            }
            requestAnimationFrame(smoothUpdate);
        }

        document.querySelectorAll('#objectResizeHandles .resize-handle').forEach(handle => {
            handle.style.pointerEvents = 'auto';
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isResizingObject = true;
                activeHandle = handle.dataset.h;
                resizeStart = {
                    w: parseInt(elements.objWidthInput.value),
                    h: parseInt(elements.objHeightInput.value),
                    mx: mouse.targetX,
                    my: mouse.targetY
                };
            });
        });

        elements.loadMusicBtn.addEventListener('click', () => { initAudio(); elements.musicInput.click(); });
        elements.musicInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                elements.audio.src = URL.createObjectURL(file);
                elements.audio.play();
                elements.playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }
        });

        elements.musicToggle.addEventListener('click', () => {
            initAudio();
            if (elements.audio.paused) {
                elements.audio.play();
                elements.playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
                if (audioCtx.state === 'suspended') audioCtx.resume();
            } else {
                elements.audio.pause();
                elements.playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            }
        });

        elements.audioSettingsBtn.addEventListener('click', (e) => { e.stopPropagation(); elements.audioSettingsMenu.classList.toggle('show'); });
        window.addEventListener('click', () => elements.audioSettingsMenu.classList.remove('show'));
        elements.speedSlider.addEventListener('input', (e) => { elements.audio.playbackRate = e.target.value; elements.speedValue.innerText = e.target.value + 'x'; });
        elements.offsetSlider.addEventListener('input', (e) => { if (elements.audio.duration) elements.audio.currentTime = (e.target.value / 100) * elements.audio.duration; });
        elements.volume.addEventListener('input', (e) => elements.audio.volume = e.target.value);

        window.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.includes('image')) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => { pastedImageBuffer = img; elements.pasteModal.classList.add('show'); };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        elements.pasteAsObject.addEventListener('click', () => { if (pastedImageBuffer) { addToLibrary(pastedImageBuffer.src); insertObject(pastedImageBuffer.src); elements.pasteModal.classList.remove('show'); } });
        elements.pasteAsBackground.addEventListener('click', () => { if (pastedImageBuffer) { ctx.drawImage(pastedImageBuffer, 0, 0, elements.canvas.width, elements.canvas.height); saveState(); elements.pasteModal.classList.remove('show'); } });
        elements.cancelPaste.onclick = () => elements.pasteModal.classList.remove('show');

        function getPos(e) {
            const rect = elements.canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (cx - rect.left) * (elements.canvas.width / rect.width),
                y: (cy - rect.top) * (elements.canvas.height / rect.height)
            };
        }

        elements.floatingPreview.addEventListener('mousedown', (e) => {
            if (isMovingSelection) {
                e.stopPropagation();
                isDraggingObject = true;
                dragOffset.x = mouse.targetX - objectPos.x;
                dragOffset.y = mouse.targetY - objectPos.y;
            }
        });

        function startDrawing(e) {
            const pos = getPos(e);
            if (isMovingSelection) return;
            if (currentTool === 'text') {
                ctx.font = `${elements.size.value}px ${elements.fontPicker.value}`; 
                ctx.fillStyle = elements.color.value;
                ctx.fillText(elements.textInput.value || "Текст", pos.x, pos.y);
                saveState(); return;
            }
            isDrawing = true; lastPos = pos;
            if (currentTool === 'bucket') { floodFill(Math.floor(pos.x), Math.floor(pos.y), elements.color.value); saveState(); isDrawing = false; }
            else if (currentTool === 'scissors') { selectionStart = pos; elements.selectionBox.style.display = 'block'; }
            else if (currentTool === 'wave') { lastWaveX = pos.x; lastWaveY = pos.y; }
        }

        let lastWaveX = 0, lastWaveY = 0;

        function handleMouseMove(e) {
            const pos = getPos(e);
            mouse.targetX = pos.x; mouse.targetY = pos.y;
            
            if (!isDrawing) return;
            let size = parseInt(elements.size.value); 
            const mode = elements.brushMode.value;
            
            if (currentTool === 'scissors') {
                const rect = elements.canvas.getBoundingClientRect();
                const x1 = Math.min(pos.x, selectionStart.x) * (rect.width/elements.canvas.width);
                const y1 = Math.min(pos.y, selectionStart.y) * (rect.height/elements.canvas.height);
                const w = Math.abs(pos.x - selectionStart.x) * (rect.width/elements.canvas.width);
                const h = Math.abs(pos.y - selectionStart.y) * (rect.height/elements.canvas.height);
                elements.selectionBox.style.left = x1+'px'; elements.selectionBox.style.top = y1+'px';
                elements.selectionBox.style.width = w+'px'; elements.selectionBox.style.height = h+'px';
            } else if (currentTool === 'wave') {
                const dx = pos.x - lastWaveX, dy = pos.y - lastWaveY;
                if (Math.abs(dx) > 0.1 || Math.abs(dy) > 0.1) { applyLiquifyEffect(pos.x, pos.y, dx, dy, size); lastWaveX = pos.x; lastWaveY = pos.y; }
            } else {
                ctx.lineWidth = size; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                if (currentTool === 'eraser') ctx.globalCompositeOperation = 'destination-out';
                else { ctx.globalCompositeOperation = 'source-over'; ctx.strokeStyle = elements.color.value; }

                if (mode === 'glow' && currentTool === 'brush') {
                    updateGlowTexture(elements.color.value, size);
                    const dist = Math.hypot(pos.x - lastPos.x, pos.y - lastPos.y), angle = Math.atan2(pos.y - lastPos.y, pos.x - lastPos.x);
                    for (let i = 0; i < dist; i += 1) {
                        const px = lastPos.x + Math.cos(angle) * i, py = lastPos.y + Math.sin(angle) * i;
                        ctx.drawImage(glowCanvas, px - glowCanvas.width/2, py - glowCanvas.height/2);
                    }
                } else if (mode === 'pixel') {
                    const s = Math.max(5, size);
                    if (currentTool === 'eraser') ctx.clearRect(Math.floor(pos.x/s)*s, Math.floor(pos.y/s)*s, s, s);
                    else { ctx.fillStyle = elements.color.value; ctx.fillRect(Math.floor(pos.x/s)*s, Math.floor(pos.y/s)*s, s, s); }
                } else if (mode === 'rainbow' && currentTool === 'brush') {
                    hue = (hue + 2) % 360; ctx.strokeStyle = `hsl(${hue}, 80%, 60%)`;
                    ctx.beginPath(); ctx.moveTo(lastPos.x, lastPos.y); ctx.lineTo(pos.x, pos.y); ctx.stroke();
                } else { ctx.beginPath(); ctx.moveTo(lastPos.x, lastPos.y); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
                ctx.globalCompositeOperation = 'source-over';
            }
            lastPos = pos;
        }

        function applyLiquifyEffect(cx, cy, dx, dy, radius) {
            const r2 = radius * radius, areaSize = Math.ceil(radius * 2);
            let drawX = Math.max(0, Math.floor(cx - radius)), drawY = Math.max(0, Math.floor(cy - radius));
            let actualW = Math.min(elements.canvas.width, drawX + areaSize) - drawX, actualH = Math.min(elements.canvas.height, drawY + areaSize) - drawY;
            if (actualW <= 0 || actualH <= 0) return;
            const imgData = ctx.getImageData(drawX, drawY, actualW, actualH), pixels = new Uint32Array(imgData.data.buffer), original = new Uint32Array(pixels);
            for (let j = 0; j < actualH; j++) {
                const ry = (drawY + j) - cy;
                for (let i = 0; i < actualW; i++) {
                    const rx = (drawX + i) - cx, d2 = rx * rx + ry * ry;
                    if (d2 < r2) {
                        const weight = Math.pow(1 - Math.sqrt(d2) / radius, 2);
                        const sx = Math.round(i - (dx * weight * 0.8)), sy = Math.round(j - (dy * weight * 0.8));
                        if (sx >= 0 && sx < actualW && sy >= 0 && sy < actualH) pixels[j * actualW + i] = original[sy * actualW + sx];
                    }
                }
            }
            ctx.putImageData(imgData, drawX, drawY);
        }

        function stopDrawing() {
            isDraggingObject = false; 
            isResizingObject = false; 
            if (!isDrawing) return; isDrawing = false;
            if (currentTool === 'scissors') {
                const sBox = elements.selectionBox.getBoundingClientRect(), cRect = elements.canvas.getBoundingClientRect();
                const x = (sBox.left - cRect.left) * (elements.canvas.width / cRect.width), y = (sBox.top - cRect.top) * (elements.canvas.height / cRect.height);
                const w = sBox.width * (elements.canvas.width / cRect.width), h = sBox.height * (elements.canvas.height / cRect.height);
                if (w > 5) {
                    selectedImageData = ctx.getImageData(x, y, w, h);
                    elements.objWidthInput.value = Math.round(w); 
                    elements.objHeightInput.value = isProportionsLocked ? Math.round(w) : Math.round(h);
                    elements.brushSizeSection.classList.add('hidden'); elements.objectSizeSection.classList.remove('hidden');
                    updateObjectScale(); 
                    objectPos.x = x + w/2; objectPos.y = y + h/2;
                    elements.floatingPreview.style.display = 'block'; ctx.clearRect(x, y, w, h); isMovingSelection = true;
                }
                elements.selectionBox.style.display = 'none';
            }
            saveState();
        }

        function insertObject(url) {
            const img = new Image(); img.crossOrigin = "anonymous";
            img.onload = () => {
                activeLibraryImg = img; selectedImageData = null;
                const startSize = parseInt(elements.size.value);
                const aspect = img.width / img.height;
                if (isProportionsLocked) {
                    elements.objWidthInput.value = startSize;
                    elements.objHeightInput.value = startSize;
                } else if (aspect >= 1) {
                    elements.objWidthInput.value = startSize;
                    elements.objHeightInput.value = Math.round(startSize / aspect);
                } else {
                    elements.objHeightInput.value = startSize;
                    elements.objWidthInput.value = Math.round(startSize * aspect);
                }
                elements.brushSizeSection.classList.add('hidden'); elements.objectSizeSection.classList.remove('hidden');
                updateObjectScale(); 
                objectPos.x = elements.canvas.width/2; objectPos.y = elements.canvas.height/2;
                elements.floatingPreview.style.display = 'block'; isMovingSelection = true;
            };
            img.src = url;
        }

        function floodFill(x, y, col) {
            const img = ctx.getImageData(0,0, elements.canvas.width, elements.canvas.height), data = img.data;
            const r = parseInt(col.slice(1,3), 16), g = parseInt(col.slice(3,5), 16), b = parseInt(col.slice(5,7), 16);
            const start = (y * elements.canvas.width + x) * 4, sr = data[start], sg = data[start+1], sb = data[start+2], sa = data[start+3];
            if (sr === r && sg === g && sb === b && sa === 255) return;
            const q = [[x, y]];
            while(q.length) {
                const [cx, cy] = q.pop(); const i = (cy * elements.canvas.width + cx) * 4;
                if (cx >= 0 && cx < elements.canvas.width && cy >= 0 && cy < elements.canvas.height && data[i] === sr && data[i+1] === sg && data[i+2] === sb && data[i+3] === sa) {
                    data[i] = r; data[i+1] = g; data[i+2] = b; data[i+3] = 255;
                    q.push([cx+1, cy], [cx-1, cy], [cx, cy+1], [cx, cy-1]);
                }
            }
            ctx.putImageData(img, 0, 0);
        }

        elements.canvas.addEventListener('mousedown', startDrawing);
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', stopDrawing);
        elements.clear.onclick = () => { ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height); saveState(); };
        elements.save.onclick = () => { 
            const temp = document.createElement('canvas'); temp.width = elements.canvas.width; temp.height = elements.canvas.height;
            const tctx = temp.getContext('2d'); tctx.fillStyle = "white"; tctx.fillRect(0,0,temp.width,temp.height);
            tctx.drawImage(elements.canvas, 0, 0);
            const a = document.createElement('a'); a.download = 'art.png'; a.href = temp.toDataURL(); a.click(); 
        };
        elements.size.oninput = (e) => elements.sizeInput.value = e.target.value;
        elements.sizeInput.oninput = (e) => elements.size.value = e.target.value;
        
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => { 
                if (!btn.classList.contains('history-btn') && !['loadMusicBtn', 'audioSettingsBtn', 'musicToggle'].includes(btn.id)) {
                    currentTool = btn.id.replace('Btn', '');
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
                }
                if (btn.id === 'textBtn') { elements.textToolSettings.classList.remove('hidden'); elements.modePanel.classList.add('hidden'); }
                else if (!btn.classList.contains('history-btn') && !['loadMusicBtn', 'audioSettingsBtn', 'musicToggle'].includes(btn.id)) { elements.textToolSettings.classList.add('hidden'); elements.modePanel.classList.remove('hidden'); }
            });
        });

        elements.uploadObjectBtn.onclick = () => elements.objectFile.click();
        elements.objectFile.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const r = new FileReader();
                r.onload = (ev) => { addToLibrary(ev.target.result); insertObject(ev.target.result); };
                r.readAsDataURL(file);
            }
        };

        elements.container.onmouseenter = () => elements.brushCursor.style.display = 'block';
        elements.container.onmouseleave = () => elements.brushCursor.style.display = 'none';
        elements.undo.onclick = undo;
        elements.redo.onclick = redo;
        window.onresize = initCanvas;
    </script>
</body>
</html>
